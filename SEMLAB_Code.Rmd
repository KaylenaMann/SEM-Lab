---
title: "SEM"
output:
  word_document: default
  html_document: default
always_allow_html: true
---
# Structural Equation Modeling Lab

## Part 0: Set-up
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(webshot2)
```

Installing and calling required packages
```{r}
#install.packages(c("lavaan","semPlot","corrplot"))
#install.packages("semTools")
library(lavaan)
library(semPlot)
library(corrplot)
library(semTools)
library(ggplot2)
library(tidyverse)
library(lavaanPlot)
library(tidySEM)
library(psych)
```

## Part 1. Basic Structural Model of observed variables / Path analysis
### 1.1 Regression equivalency

#### Data Loading
```{r}
# set work directory it if needed
# load in data
fomo<- read.csv("fomo.csv")
str(fomo)
names(fomo)
```
#### linear regression
```{r}
# this part is used to demonstrate that path analysis is equivalent to regression
lm1<- lm(Boredom~ Anxiety + Dep, data=fomo) 
summary(lm1)
```
#### Path Analysis
```{r}
#model specification
m1<-'
Boredom~ Anxiety + Dep
Anxiety ~~ Dep
Anxiety ~~ Anxiety
Dep ~~ Dep
'
#model fit
fit1_PA <- sem(m1,data=fomo)
summary(fit1_PA, fit.measures=T, standardized=T, rsquare=T)
```
Both linear regression and path analysis have the same estimates (anxiety = .34; Dep = .56, etc.)

### 1.2 Assumption checking
#### Assumption 1: Multivariate normality
```{r}
#Histograms
ggplot(gather(fomo), aes(value)) + 
  geom_histogram(bins = 10) + 
  facet_wrap(~key, scales = 'free_x')

#Mardia test of multivariate normality
mardia(fomo)
```
From the output, we can see that variable Anxiety and Depression are not normally distributed. We can consider transformations for Anxiety and Depression referring to previous labs covered in GLM classes
#### Assumption 2: Sample size
```{r}
str(fomo) 
```
A rule of thumb when ML (maximum likelihood) method is used for estimation is:
The ratio of sample size (N) to # parameters (q) should be larger than 5:1 or 10:1.

#### Assumption 3: Outliers
```{r}
#Typically a p-value that is less than .001 is considered to be an outlier based on Mahalanobis distance
fomo$mahal<-mahalanobis(fomo, colMeans(fomo), cov(fomo))
df <- ncol(fomo)
fomo$p <- pchisq(fomo$mahal, df=df, lower.tail=FALSE)
fomo
fomo$p[fomo$p<.001]
which(fomo$p<.001)
```
Interpretation: As we can see from the result, we have no outliers.

#### Assumption 4: Missing data
```{r}
colSums(is.na(fomo))
```
Interpretation: There is no missing data in fomo dataset. We shall proceed with our analysis.

### 1.3 Model building

#### Initial Model Specification
```{r}
m2<- '
Boredom ~ Anxiety + Dep
FOMO ~ Boredom
Anxiety ~~ Dep
'
#model fit
fit2_pa<- sem(m2, data=fomo) #fit the model

#inspect model specification
inspect(fit2_pa) 
```
To ensure that we have correctly specify the model, we can use inspect() to check model specification. It allows us to examine the number of estimated parameters in the model.
#### Parameter Interpretation 
```{r}
# interpret estimated parameters
summary(fit2_pa, fit.measures=TRUE,standardized=TRUE,rsquare=TRUE) 
```
#### sample covariance matrix and implied covariance matrix
```{r}
inspect(fit2_pa,"sampstat") #sample stat generated by lavaan
fitted(fit2_pa)
```
The sample covariance matrix and implied covariance matrix are very similar, with only small differences.
#### Model fit
```{r}
# Overall Model fit
summary(fit2_pa, fit.measures=TRUE,standardized=TRUE,rsquare=TRUE) 

# For all types of fit
fitmeasures(fit2_pa)
```
#### Examine residuals
To understand why our model does not fit the data well, we can examine the residuals.
```{r}
resid(fit2_pa)
resid(fit2_pa,type="standardized")
resid(fit2_pa,type="normalized")
```
#### Visualize simple model 
```{r}
semPaths(fit2_pa, what="path", whatLabels="std", residuals=FALSE)
```
### 1.4 Model re-specification
Modification indices (MI) are suggestions for potential model specifications (through the inclusion of additional parameters) that may result in an increase in model fit.
```{r}
modindices(fit2_pa)
```
For our model, the MI for FOMO ~ Anxiety is the largest suggesting by adding the path relationship from Anxiety to FOMO will improve our model fit.

```{r}
m3<- '
Boredom ~ Anxiety + Dep
FOMO ~ Boredom + Anxiety  #adding path between FOMO and Anxiety
Anxiety ~~ Dep
'
fit3_pa <- sem(m3, data=fomo)
inspect(fit3_pa)
summary(fit3_pa, fit.measures=TRUE,standardized=TRUE,rsquare=TRUE)
```

```{r}
anova(fit2_pa, fit3_pa)
lavTestLRT(fit2_pa, fit3_pa)
```

```{r}
#model diagram with parameters
semPaths(fit2_pa,what = "paths",whatLabels = "par",layout="tree3",residuals=T)
semPaths(fit3_pa,what = "paths",whatLabels = "par",layout="tree",residuals=T)

# More simple plots
lavaanPlot(model = fit2_pa, coefs = T)
lavaanPlot(model = fit3_pa, coefs = T)

# Easy parameter understanding
table_results(fit2_pa)
table_results(fit3_pa)

# Another plot option
graph_sem(fit2_pa)
graph_sem(fit3_pa)
```

## Part 2: Full SEM 

### Data import
```{r}
hbat<-read.csv("hbat_sem.csv")
str(hbat)
names(hbat)
hbat.sem<-hbat[,1:27] #we excluded variables with the same names as latent variables
names(hbat.sem)
```

### 2.1 Stage 1: Defining the Initial Constructs
Based on published literature and some preliminary interviews with employees, HBAT initiated the research project focusing on five key constructs to study employee turnover problem. The five constructs of interest are Job satisfaction (JS), Organizational commitment (OC), Staying intentions (SI), Environmental perceptions (EP), and Attitudes toward coworkers (AC).

### 2.2 Stage 2: Developing the Overall Measurement Model
In this stage, researchers must specify the measurement model to be tested including relationships among constructs defined and the nature of each construct (reflective versus formative). In this case, all measures are hypothesized as reflective, the direction is from the latent construct to the measured items.  

### 2.3 Stage 3: Designing a study to produce empirical results
```{r}
mcfa<- '
JS =~ JS1+JS2+JS3+JS4+JS5
AC =~ AC1+AC2+AC3+AC4
OC =~ OC1+OC2+OC3+OC4
EP =~ EP1+EP2+EP3+EP4
SI =~ SI1+SI2+SI3+SI4
'
fcfa<- cfa(mcfa,data=hbat.sem)
inspect(fcfa)
```

### 2.4 Stage 4: Assessing Measurement Validity
In this stage, we examined the results of testing measurement theory by comparing the theoretical measurement model against reality, as represented by the sample covariance matrix. We first examined the overall fit through key GOF values, construct validity consisting of convergent validity, discriminant validity, and nomological validity. Then, path estimates, standardized residuals, and modification indices were further examined for model improvement.

#### Overall fit
```{r}
summary(fcfa,standardized=T, fit.measures=T, rsquare=T)
```
Chi-square, CFI, and RMSEA are evaluated. Reults show that HBAT measurement model provides a reasonably good fit. 
#### Construct Validity 
```{r}
# convergent validity
#AVE 
(0.740^2+0.748^2+0.680^2+0.705^2+0.731^2)/5 #JS
(0.822^2+0.820^2+0.837^2+0.815^2)/4 #AC
(0.583^2+0.886^2+0.657^2+0.836^2)/4 #OC
(0.692^2+0.803^2+0.779^2+0.823^2)/4 #EP
(0.811^2+0.864^2+0.741^2+0.852^2)/4 #SI
```
An AVE of less than .5 indicates that, on average, more error remains in the items than variance held in common with the latent factor upon which they load. We have adequate convergent validity. 

```{r}
# discriminant validity
inspect(fcfa, "cor.lv")
lvcorr<- inspect(fcfa, "cor.lv")
lvcorr^2
```
AVE estimates for two fsctors should be greater than the square of the correlation between two factors to provide evidence of discriminant vlaidity. All AVE estimates are greater than the corresponding interconstruct squared correlation estimates. Therefore, this test indicates there are no problems with discriminant validity for the HBAT CFA model.

```{r}
# Nomological validity
inspect(fcfa, "cor.lv")
```
The correlation matrix provides a useful start in this effort to the extent that the constructs are expected to relate to one another.
```{r}
# reliability 
semTools::reliability(fcfa)
```
Construct reliability should be .7 or higher to indicate adequate internal consistency. the alpha for JS construct did not reach expected level. The internal reliability does not hold.

#### model modification
```{r}
resid(fcfa,"standardized")
```

### 2.5 Stage 5: Specifying the model
For reflective models, =~ is used to specify the measurement models

#### Specification
```{r}
m1<- '
JS =~ JS1+JS2+JS3+JS4+JS5
AC =~ AC1+AC2+AC3+AC4
OC =~ OC1+OC2+OC3+OC4
EP =~ EP1+EP2+EP3+EP4
SI =~ SI1+SI2+SI3+SI4
JS ~ EP +AC
OC ~ EP + AC + JS
SI ~ JS + OC
EP ~~ AC

'
fit1_SEM<- sem(model=m1, data=hbat.sem)
summary(fit1_SEM, standardized=T, rsquare=T, fit.measures=T)
```

#### Visualizing
```{r}
fitmeasures(fit1_SEM)
semTools::reliability(fit1_SEM)
semPaths(fit1_SEM,rotation =2,layout = "tree2",style = "lisrel")
semPaths(fit1_SEM,what = "path", whatLabels = "par", residuals = T,rotation =2,layout = "tree2",style = "lisrel",groups = "latents")
semPaths(fit1_SEM, what = "path",whatLabels="par", rotation = 2, layout="tree2",structural=T)

# More simple plots
lavaanPlot(model = fit1_SEM, coefs = T)

# Easy parameter understanding
table_results(fit1_SEM)
```

### 2.6 Stage 6: Assessing structural model validity

#### Factor loadings
```{r}
#extract factor loadings of cfa model and SEM model1
inspect(fcfa,"std")$lambda
loadingcfa<-inspect(fcfa,"std")$lambda

inspect(fit1_SEM,"std")$lambda
loadingfit1<-inspect(fit1_SEM,"std")$lambda
```

#### Fit measures
```{r}
# View  fit measures
attributes(fitmeasures(fcfa))

# Select specific fit indices
cfaindices <- fitmeasures(fcfa, 
                          fit.measures = c("chisq","df","pvalue","gfi","rmsea",
                                           "rmsea.ci.lower","rmsea.ci.upper",
                                           "rmr","srmr","nfi","nnfi","cfi",
                                           "rfi","agfi","pnfi"))

fit1indices <- fitmeasures(fit1_SEM, 
                           fit.measures = c("chisq","df","pvalue","gfi","rmsea",
                                            "rmsea.ci.lower","rmsea.ci.upper",
                                            "rmr","srmr","nfi","nnfi","cfi",
                                            "rfi","agfi","pnfi"))

# Convert to data frame
cfaindices_df  <- as.data.frame(cfaindices)
fit1indices_df <- as.data.frame(fit1indices)
options(scipen = 999)  

# Combine into a single table
goftable <- cbind(cfaindices_df, fit1indices_df)
colnames(goftable) <- c("CFA Model", "Employee Retention Model")
round(goftable, 3)
```

#### Model Respecificiation
```{r}

m2<- '
JS =~ JS1+JS2+JS3+JS4+JS5
AC =~ AC1+AC2+AC3+AC4
OC =~ OC1+OC2+OC3+OC4
EP =~ EP1+EP2+EP3+EP4
SI =~ SI1+SI2+SI3+SI4
JS ~ EP +AC
OC ~ EP + AC + JS
SI ~ JS + OC +EP
EP ~~ AC

'
fit2_SEM<- sem(model=m2, data=hbat.sem)
summary(fit2_SEM, standardized=T, rsquare=T, fit.measures=T)
```

#### Evaluating parameters
```{r}
fit2indices <- fitmeasures(fit2_SEM,
                           fit.measures = c("chisq","df","pvalue","gfi","rmsea",
                                            "rmsea.ci.lower","rmsea.ci.upper",
                                            "rmr","srmr","nfi","nnfi","cfi",
                                            "rfi","agfi","pnfi"))
fit2_df <- as.data.frame(fit2indices)
cfa_df  <- as.data.frame(cfaindices)
fit1_df <- as.data.frame(fit1indices)
options(scipen = 999)

# Combine 
goftable2 <- cbind(cfa_df, fit1_df, fit2_df)
colnames(goftable2) <- c("CFA", "Retention", "Revised")
round(goftable2, 3)

semTools::reliability(fit2_SEM)
anova(fit1_SEM,fit2_SEM)
```

#### Visualizing final model
```{r}
semPaths(fit2_SEM,what = "path", whatLabels = "std", residuals = T,rotation =2,layout = "tree2",style = "lisrel",groups = "latents")

# More simple plots
lavaanPlot(model = fit2_SEM, coefs = T)

# Easy parameter understanding
table_results(fit2_SEM)
```

